<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Air Hockey - –û–Ω–ª–∞–π–Ω</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            touch-action: none; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background-color: #333; 
        }
        #game-area { 
            width: 600px; 
            height: 400px; 
            background-color: #008080; 
            border: 10px solid #ccc; 
            position: relative; 
            overflow: hidden; 
            max-width: 95vw; 
            max-height: 95vh;
            box-sizing: content-box;
        }
        .game-object { 
            position: absolute; 
            border-radius: 50%; 
            border: 3px solid black; 
        }
        
        .player-mallet { 
            width: 50px; 
            height: 50px; 
            cursor: grab; 
            z-index: 10;
        }
        #player1 { background-color: blue; }
        #player2 { background-color: red; }
        
        #puck {
            width: 30px; 
            height: 30px;
            background-color: black;
            z-index: 5;
        }

        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #score-board {
            position: absolute;
            top: 5px;
            width: 100%;
            text-align: center;
            font-size: 24px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 30;
        }
        #status-message { 
            position: absolute; 
            bottom: 5px; 
            width: 100%;
            text-align: center;
            color: white; 
            font-family: Arial, sans-serif; 
            z-index: 20;
        }
        
        /* –õ—ñ–Ω—ñ—è —Ç–∞ –≤–æ—Ä–æ—Ç–∞ */
        #game-area::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.5);
            transform: translateX(-50%);
        }
        .goal-post {
            position: absolute;
            width: 10px;
            height: 120px; 
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            border: 2px dashed rgba(255, 255, 255, 0.4);
        }
        #goal-left { left: 0px; }
        #goal-right { right: 0px; }

    </style>
</head>
<body>
    <div id="game-area">
        <div id="goal-left" class="goal-post"></div>
        <div id="goal-right" class="goal-post"></div>
        
        <div id="player1" class="player-mallet game-object"></div>
        <div id="player2" class="player-mallet game-object"></div>
        <div id="puck" class="game-object"></div>
        
        <div id="score-board">0 : 0</div>
        <div id="status-message">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // *** –ê–î–†–ï–°–ê –í–ê–®–û–ì–û REPLIT-–°–ï–†–í–ï–†–ê ***
        const SERVER_URL = 'https://73cb3e0f-9347-442d-8324-f8f7d845c9c0-00-3avk0bxajugjr.kirk.replit.dev';
        // **********************************

        // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø CSP: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–∏—à–µ WebSockets ---
        const socket = io(SERVER_URL, {
            transports: ['websocket']
        });

        const gameArea = document.getElementById('game-area');
        const scoreBoard = document.getElementById('score-board');
        const statusMessage = document.getElementById('status-message');
        const player1Mallet = document.getElementById('player1');
        const player2Mallet = document.getElementById('player2');
        const puckElement = document.getElementById('puck');

        let myPlayerNumber = 0; 
        let myMallet = null;
        
        const MALLET_SIZE = 50;
        const GAME_WIDTH = 600;

        // ---------------------------------------------------
        // –£–ù–Ü–í–ï–†–°–ê–õ–¨–ù–ê –õ–û–ì–Ü–ö–ê –†–£–•–£ (–ú–ò–®–ê + –î–û–¢–ò–ö) 
        // ---------------------------------------------------
        
        function getCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            } else {
                return e;
            }
        }

        function enableDragging(malletElement) {
            if (!malletElement) return;

            let shiftX, shiftY;

            function moveAt(pageX, pageY) {
                // !!! –ì–æ–ª–æ–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç –Ω–∞–ª–µ–∂–∏—Ç—å –ø–æ—Ç–æ—á–Ω–æ–º—É –≥—Ä–∞–≤—Ü—é !!!
                if (malletElement !== myMallet || myPlayerNumber === 0) return; 

                let newX = pageX - shiftX - gameArea.getBoundingClientRect().left;
                let newY = pageY - shiftY - gameArea.getBoundingClientRect().top;

                // –û–±–º–µ–∂–µ–Ω–Ω—è –ø–æ–ª—è
                newX = Math.max(0, Math.min(gameArea.clientWidth - malletElement.offsetWidth, newX));
                newY = Math.max(0, Math.min(gameArea.clientHeight - malletElement.offsetHeight, newY));

                // –û–±–º–µ–∂–µ–Ω–Ω—è –ø–æ–ª–æ–≤–∏–Ω–∏ –ø–æ–ª—è
                if (myPlayerNumber === 1) {
                    newX = Math.min((GAME_WIDTH / 2) - MALLET_SIZE, newX);
                } 
                else if (myPlayerNumber === 2) {
                    newX = Math.max(GAME_WIDTH / 2, newX);
                }

                malletElement.style.left = newX + 'px';
                malletElement.style.top = newY + 'px';
                
                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                socket.emit('player_move', { x: newX, y: newY });
            }

            function startDrag(e) {
                if (malletElement !== myMallet || myPlayerNumber === 0) return; 

                const coords = getCoords(e);
                
                shiftX = coords.clientX - malletElement.getBoundingClientRect().left;
                shiftY = coords.clientY - malletElement.getBoundingClientRect().top;
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('touchmove', onTouchMove, { passive: false }); 
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);

                if (e.type === 'touchstart') {
                     e.preventDefault(); 
                }
            }

            function onMouseMove(e) { moveAt(e.clientX, e.clientY); }
            function onTouchMove(e) { const coords = getCoords(e); moveAt(coords.clientX, coords.clientY); }
            function endDrag() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('mouseup', endDrag);
                document.removeEventListener('touchend', endDrag);
            }
            
            malletElement.addEventListener('mousedown', startDrag);
            malletElement.addEventListener('touchstart', startDrag);
            malletElement.ondragstart = () => false; 
        }

        enableDragging(player1Mallet);
        enableDragging(player2Mallet);


        // ---------------------------------------------------
        // SOCKET.IO (–ó–í'–Ø–ó–û–ö –Ü–ó –°–ï–†–í–ï–†–û–ú)
        // ---------------------------------------------------

        socket.on('connect', () => {
            statusMessage.textContent = '‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ. –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ä–æ–ª—ñ...';
        });

        socket.on('player_assignment', (playerNumber) => {
            myPlayerNumber = playerNumber;
            
            if (myPlayerNumber === 1) {
                myMallet = player1Mallet;
                myMallet.style.backgroundColor = 'lime'; 
                statusMessage.textContent = '–í–∏ –ì—Ä–∞–≤–µ—Ü—å 1 (–°–∏–Ω—è –∑–æ–Ω–∞). –ß–µ–∫–∞—î–º–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞.';
            } else if (myPlayerNumber === 2) {
                myMallet = player2Mallet;
                myMallet.style.backgroundColor = 'lime'; 
                statusMessage.textContent = '–í–∏ –ì—Ä–∞–≤–µ—Ü—å 2 (–ß–µ—Ä–≤–æ–Ω–∞ –∑–æ–Ω–∞). –ß–µ–∫–∞—î–º–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞.';
            } else {
                myMallet = null; 
                statusMessage.textContent = '‚ùå –£—Å—ñ –º—ñ—Å—Ü—è –∑–∞–π–Ω—è—Ç—ñ. –í–∏ –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á.';
            }
        });

        socket.on('game_start', (msg) => {
            statusMessage.textContent = `üöÄ ${msg}`;
            if (myMallet) {
                myMallet.style.backgroundColor = 'white';
            }
        });

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –≤—Å—ñ—î—ó –≥—Ä–∏ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ (–í–ò–ü–†–ê–í–õ–ï–ù–û!)
        socket.on('game_update', (gameState) => {
            // 1. –û–Ω–æ–≤–ª—é—î–º–æ —à–∞–π–±—É –∑–∞–≤–∂–¥–∏
            puckElement.style.left = (gameState.puck.x - gameState.puck.radius) + 'px';
            puckElement.style.top = (gameState.puck.y - gameState.puck.radius) + 'px';
            
            const p1_left = (gameState.player1.x - gameState.player1.radius) + 'px';
            const p1_top = (gameState.player1.y - gameState.player1.radius) + 'px';
            const p2_left = (gameState.player2.x - gameState.player2.radius) + 'px';
            const p2_top = (gameState.player2.y - gameState.player2.radius) + 'px';
            
            
            if (myPlayerNumber === 1) {
                // –Ø –ì—Ä–∞–≤–µ—Ü—å 1: –æ–Ω–æ–≤–ª—é—é –ª–∏—à–µ –∫–ª—é—á–∫—É —Å—É–ø–µ—Ä–Ω–∏–∫–∞ (Player 2)
                player2Mallet.style.left = p2_left;
                player2Mallet.style.top = p2_top;
            } 
            else if (myPlayerNumber === 2) {
                // –Ø –ì—Ä–∞–≤–µ—Ü—å 2: –æ–Ω–æ–≤–ª—é—é –ª–∏—à–µ –∫–ª—é—á–∫—É —Å—É–ø–µ—Ä–Ω–∏–∫–∞ (Player 1)
                player1Mallet.style.left = p1_left;
                player1Mallet.style.top = p1_top;
            } 
            else {
                // –Ø –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á: —Ä—É—Ö–∞—é –æ–±–∏–¥–≤—ñ
                player1Mallet.style.left = p1_left;
                player1Mallet.style.top = p1_top;
                player2Mallet.style.left = p2_left;
                player2Mallet.style.top = p2_top;
            }
        });
        
        socket.on('goal', (score) => {
            scoreBoard.textContent = `${score.player1} : ${score.player2}`;
            statusMessage.textContent = `–ì–û–õ! –ù–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫: ${score.player1} : ${score.player2}. –®–∞–π–±–∞ –ø–æ–≤–µ—Ä–Ω—É–ª–∞—Å—è —É —Ü–µ–Ω—Ç—Ä.`;
        });
        
        socket.on('opponent_disconnected', (msg) => {
             scoreBoard.textContent = `0 : 0`;
             statusMessage.textContent = `üö´ ${msg}`;
             if (myMallet) {
                 myMallet.style.backgroundColor = 'lime';
             }
        });
        
    </script>
</body>
</html>
